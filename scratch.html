<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9364231981895017" crossorigin="anonymous"></script>
    <meta name="google-site-verification" content="ca-pub-9364231981895017" />
    <meta name="google-adsense-account" content="ca-pub-9364231981895017">
    <title>Cash Op - Scratch Card</title>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <button onclick="goBack()" class="icon-btn back-btn">
                    <span class="material-icons">arrow_back</span>
                </button>
                <h1 class="app-title">Scratch Card</h1>
                <div></div>
            </div>
        </header>
        
        <main class="app-main">
            <div class="scratch-section">
                <div class="scratch-card">
                    <div class="scratch-overlay" id="scratchOverlay">
                        <p>Scratch here to reveal your prize!</p>
                    </div>
                    <div class="prize-reveal" id="prizeReveal">
                        <div class="prize-icon">
                            <span class="material-icons" id="prizeIcon">card_giftcard</span>
                        </div>
                        <p class="prize-text" id="prizeText">You won $0.50!</p>
                        <button class="claim-btn" onclick="claimPrize()">Claim Prize</button>
                    </div>
                </div>
                <p class="instructions">Tap and hold to scratch the card</p>
                <button class="new-card-btn" onclick="newCard()">Get New Card (₹0.10)</button>
                
                <!-- Ad Banner -->
                <div class="ad-container">
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-9364231981895017"
                         data-ad-slot="YOUR_AD_SLOT_ID"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
            </div>
        </main>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCKW4dfNxG_7F-K8jO31i2aS8eI1Vv-SYE",
            authDomain: "cash-op-web.firebaseapp.com",
            projectId: "cash-op-web",
            storageBucket: "cash-op-web.firebasestorage.app",
            messagingSenderId: "182361117624",
            appId: "1:182361117624:web:4a38a21b441acdb8c1b54d"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'login_signup.html';
            } else {
                showAd();
                checkDailyScratch(user.uid);
            }
        });

        const overlay = document.getElementById('scratchOverlay');
        const reveal = document.getElementById('prizeReveal');
        let isScratched = false;
        let currentPrize = 0;

        function showAd() {
            // Simulate watching an ad
            alert('Please watch this short ad to continue... (Simulated ad - click OK to proceed)');
        }

        function checkDailyScratch(uid) {
            const today = new Date().toDateString();
            
            // Check Firestore for last scratch
            db.collection('users').doc(uid).get().then((doc) => {
                if (doc.exists) {
                    const lastScratch = doc.data().lastScratch;
                    if (lastScratch === today) {
                        // Already scratched today
                        overlay.innerHTML = '<p>You have already scratched today. Come back tomorrow!</p>';
                        overlay.style.pointerEvents = 'none';
                        document.querySelector('.new-card-btn').style.display = 'none';
                        document.querySelector('.instructions').textContent = 'Daily scratch limit reached';
                    }
                }
            }).catch((error) => {
                console.error('Error checking daily scratch:', error);
            });
        }

        // Simple scratch simulation
        overlay.addEventListener('touchstart', startScratch);
        overlay.addEventListener('mousedown', startScratch);

        function startScratch(e) {
            e.preventDefault();
            if (!isScratched) {
                // Simulate scratching
                setTimeout(() => {
                    scratchCard();
                }, 1000); // 1 second scratch time
            }
        }

        function scratchCard() {
            isScratched = true;
            overlay.style.display = 'none';
            reveal.style.display = 'block';
            
            // Random prize from specified amounts
            const prizes = [
                { amount: 0.001, text: 'You won ₹0.001!' },
                { amount: 0.005, text: 'You won ₹0.005!' },
                { amount: 0.01, text: 'You won ₹0.01!' },
                { amount: 0.02, text: 'You won ₹0.02!' },
                { amount: 0.03, text: 'You won ₹0.03!' },
                { amount: 0.04, text: 'You won ₹0.04!' },
                { amount: 0.05, text: 'You won ₹0.05!' },
                { amount: 0.1, text: 'You won ₹0.1!' },
                { amount: 0.2, text: 'You won ₹0.2!' }
            ];
            
            const randomPrize = prizes[Math.floor(Math.random() * prizes.length)];
            currentPrize = randomPrize.amount;
            
            document.getElementById('prizeIcon').textContent = 'card_giftcard';
            document.getElementById('prizeText').textContent = randomPrize.text;
            
            // Update balance in Firestore
            const uid = auth.currentUser.uid;
            const today = new Date().toDateString();
            
            // Read current balance, then update it
            const userRef = db.collection('users').doc(uid);
            userRef.get().then((doc) => {
                let currentBalance = 0;
                if (doc.exists) {
                    currentBalance = doc.data().balance || 0;
                } else {
                    // Create user document if it doesn't exist
                    return userRef.set({
                        balance: 0,
                        email: auth.currentUser.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => {
                        return userRef.get(); // Get the newly created document
                    });
                }
                return Promise.resolve(doc);
            }).then((doc) => {
                const currentBalance = doc.data().balance || 0;
                const newBalance = currentBalance + currentPrize;
                
                // Update balance and last scratch
                return userRef.update({
                    lastScratch: today,
                    balance: newBalance
                });
            }).then(() => {
                console.log('Prize added to balance successfully');
                alert(`Congratulations! ₹${currentPrize} has been added to your balance!`);
            }).catch((error) => {
                console.error('Error updating balance:', error);
                alert('Error updating balance. Please try again.');
            });
        }

        function claimPrize() {
            // Balance is already updated when scratching, just redirect to home
            window.location.href = 'home.html';
        }

        function newCard() {
            alert('You can only scratch once per day!');
        }

        function resetCard() {
            isScratched = false;
            overlay.style.display = 'flex';
            reveal.style.display = 'none';
            currentPrize = 0;
        }

        function goBack() {
            window.location.href = 'home.html';
        }

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>